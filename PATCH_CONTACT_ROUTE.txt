I could not run git or npm/pnpm in this environment. I updated app/api/contact/route.ts in the working tree, but you need to commit & push from your machine so Vercel can deploy.

Options to apply the change locally (pick one):

Option A — recommended: overwrite the file locally with this content, then commit & push
1. Save the file below as app/api/contact/route.ts (overwrite the existing file).
2. Run:
   git add app/api/contact/route.ts
   git commit -m "feat(api): send contact submissions via Resend with improved logging and error handling"
   git push origin main

Option B — create patch and apply with git (if you prefer a patch)
1. Create a file named PATCH_CONTACT_ROUTE.diff containing the unified diff (not provided here).
2. Apply with:
   git apply PATCH_CONTACT_ROUTE.diff
   git add app/api/contact/route.ts
   git commit -m "feat(api): send contact submissions via Resend with improved logging and error handling"
   git push origin main

Below is the full updated file content. Overwrite app/api/contact/route.ts with this exact content.

----- START FILE: app/api/contact/route.ts -----
import { NextRequest, NextResponse } from 'next/server'
import { contactPayloadSchema } from '@/lib/validators/contact'
import { checkRateLimit } from '@/lib/utils/rateLimit'
import type { ContactPayload } from '@/types/automation-types'

const RATE_MS = 60_000 // 1 minute (kept for reference)

async function sendEmailWithResend(payload: ContactPayload) {
  const apiKey = process.env.RESEND_API_KEY
  if (!apiKey) {
    throw new Error('RESEND_API_KEY not configured')
  }

  const to = process.env.CONTACT_TO_EMAIL ?? 'barrautomations@gmail.com'
  const from = process.env.RESEND_FROM ?? `Barr Automations <no-reply@${process.env.RESEND_DOMAIN ?? 'barrautomations.com'}>`
  const subject = `New Contact: ${payload.fullName} (${payload.email})`

  // Build a simple HTML representation of the payload
  const htmlLines: string[] = [
    `<h2>${subject}</h2>`,
    `<p><strong>Page:</strong> ${payload.page ?? 'contact'}</p>`,
    `<p><strong>IP:</strong> ${payload.ip ?? ''}</p>`,
    `<p><strong>User Agent:</strong> ${payload.userAgent ?? ''}</p>`,
    `<h3>Contact Details</h3>`,
    `<p><strong>Name:</strong> ${payload.fullName ?? ''}</p>`,
    `<p><strong>Email:</strong> ${payload.email ?? ''}</p>`,
  ]

  if (payload.phone) htmlLines.push(`<p><strong>Phone:</strong> ${payload.phone}</p>`)
  if (payload.company) htmlLines.push(`<p><strong>Company:</strong> ${payload.company}</p>`)
  if (payload.website) htmlLines.push(`<p><strong>Website:</strong> ${payload.website}</p>`)
  if (payload.message) htmlLines.push(`<p><strong>Message:</strong><br/>${payload.message.replace(/\n/g, '<br/>')}</p>`)

  htmlLines.push(`<h3>Discovery Answers</h3>`)
  if (payload.hoursFocus) htmlLines.push(`<p><strong>Hours Focus:</strong> ${payload.hoursFocus}</p>`)
  if (payload.followupPain && Array.isArray(payload.followupPain)) htmlLines.push(`<p><strong>Follow-up Pain:</strong> ${(payload.followupPain || []).join(', ')}</p>`)
  if (payload.repeatedLookups) htmlLines.push(`<p><strong>Repeated Lookups:</strong><br/>${payload.repeatedLookups.replace(/\n/g, '<br/>')}</p>`)
  if (payload.singlePointProcess) htmlLines.push(`<p><strong>Single Point Process:</strong><br/>${payload.singlePointProcess.replace(/\n/g, '<br/>')}</p>`)
  if (payload.morningKPIs) htmlLines.push(`<p><strong>Morning KPIs:</strong><br/>${payload.morningKPIs.replace(/\n/g, '<br/>')}</p>`)
  if (payload.integrations && Array.isArray(payload.integrations)) htmlLines.push(`<p><strong>Integrations:</strong> ${(payload.integrations || []).join(', ')}</p>`)

  const html = htmlLines.join('\n')

  const res = await fetch('https://api.resend.com/emails', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${apiKey}`,
    },
    body: JSON.stringify({
      from,
      to,
      subject,
      html,
    }),
  })

  if (!res.ok) {
    const text = await res.text().catch(() => '')
    throw new Error(`Resend API error ${res.status}: ${text}`)
  }

  const data = await res.json().catch(() => ({}))
  return data
}

export async function POST(req: NextRequest) {
  try {
    // Get client IP
    const ip = req.headers.get('x-forwarded-for')?.split(',')[0]?.trim() ||
               req.headers.get('x-real-ip') ||
               '0.0.0.0'

    // Rate limiting
    if (!checkRateLimit(ip)) {
      return NextResponse.json(
        { ok: false, error: 'Too many requests. Please try again in 10 seconds.' },
        { status: 429 }
      )
    }

    // Parse and validate request body
    const body = await req.json()

    // Honeypot check - silently accept if trap field is filled
    if (typeof body?.trap === 'string' && body.trap.length > 0) {
      return NextResponse.json({ ok: true })
    }

    // Validate payload
    const validatedFields = contactPayloadSchema.safeParse(body)
    if (!validatedFields.success) {
      console.error('contact_submit_invalid_payload:', validatedFields.error)
      return NextResponse.json(
        { ok: false, error: 'Invalid form data' },
        { status: 400 }
      )
    }

    // Build payload with metadata
    const payload: ContactPayload = {
      ...validatedFields.data,
      page: 'contact',
      userAgent: req.headers.get('user-agent') ?? '',
      ip,
    }

    // Log receipt for debugging
    console.log('contact_submit_received:', {
      fullName: payload.fullName,
      email: payload.email,
      ip,
      page: payload.page,
    })

    // Preferred path: use Resend to send email directly if configured
    if (process.env.RESEND_API_KEY) {
      try {
        const sendResult = await sendEmailWithResend(payload)
        console.log('contact_submit_resend_success:', { id: (sendResult?.id ?? null), to: process.env.CONTACT_TO_EMAIL ?? 'barrautomations@gmail.com' })
        return NextResponse.json({ ok: true })
      } catch (err) {
        console.error('contact_submit_resend_error:', err)
        // If resend fails, try n8n fallback if configured below, otherwise return error
      }
    }

    // Secondary path: Send to n8n webhook if configured
    const n8nUrl = process.env.N8N_CONTACT_WEBHOOK_URL
    if (n8nUrl) {
      try {
        const response = await fetch(n8nUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-contact-destination': process.env.CONTACT_TO_EMAIL ?? 'barrautomations@gmail.com',
          },
          body: JSON.stringify(payload),
          cache: 'no-store',
        })

        if (!response.ok) {
          const text = await response.text().catch(() => '')
          throw new Error(`n8n webhook error: ${response.status} ${text}`)
        }

        if (process.env.NODE_ENV === 'development') {
          console.log('contact_submit_n8n_success:', {
            fullName: payload.fullName,
            email: payload.email,
            ip,
          })
        }

        return NextResponse.json({ ok: true })
      } catch (error) {
        console.error('n8n webhook error:', error)
        // If n8n fails, do not silently swallow — return error so client knows
        return NextResponse.json({ ok: false, error: 'Failed to deliver contact submission' }, { status: 502 })
      }
    }

    // If we reach here and neither Resend nor n8n succeeded/configured, return an error
    console.error('contact_submit_no_delivery_path: RESEND_API_KEY and N8N_CONTACT_WEBHOOK_URL not configured or both failed')
    return NextResponse.json(
      { ok: false, error: 'No delivery method configured. Please contact support.' },
      { status: 500 }
    )
  } catch (error: any) {
    console.error('contact_submit_error:', error)

    return NextResponse.json(
      { ok: false, error: 'Server error. Please try again.' },
      { status: 500 }
    )
  }
}
----- END FILE -----

If you want, I can also generate a proper unified diff (PATCH) file here for you to apply with git apply. Reply "generate patch" and I will write PATCH_CONTACT_ROUTE.diff into the repository root.
